.controller("upgradeController", function($scope, $routeParams, User, $timeout) {
    var app = this;
    
    
    
    User.getUser($routeParams.id).then(function(data) {
        if (data.data.success) {
            
            $scope.newPermission = data.data.user.permission;
            app.currentUser = data.data.user._id;
           
        } else { 
            app.errorMsg = data.data.message;
        }
    });
    app.upgradePermission = function(newPermission) {
        app.errorMsg = false;
      
        app.disableModerator= true;
        
        
        var userObject = {};

        userObject._id = app.currentUser;
        userObject.permission = newPermission;
            User.upgradeUser(userObject).then(function(data) {
                if (data.data.success) {
                    app.successMsg = data.data.message;
                    $timeout(function() {
                        app.successMsg = false;
                            if (newPermission === 'moderator') {
                                $scope.newPermission = 'moderator';
                                app.disableUser = false;
                                app.disableModerator= true;
                               
                            } else  {
                               
                            }         
                    }, 2000);
                } else {
                    app.errorMsg = data.data.message;
                    app.disabled = false;
                }
            });
       
    };
  
})




router.put('/upgrade', function(req,res) {
        var editUser = req.body._id;
        if (req.body.permission) var newPermission = req.body.permission;
        User.findOne({username: req.decoded.username }, function(err, mainUser) {
            if (err) throw err;
            if(!mainUser) {
                res.json({ success: false, message: " No user found"});
            } else { 
                if (newPermission) {
                    
                        User.findOne({ _id: editUser}, function(err, user) {
                            if (err) throw err;
                            if (!user) {
                                res.json({ success: false, message: 'No user found'});
                            } else {
                                if (newPermission === 'moderator') {
                                            user.permission = newPermission;
                                            user.save(function(err) {
                                                if (err) {
                                                    console.log(err);
                                                } else {
                                                    res.json({ success: true, message: ' Permission updated'})
                                                }
                                            });
                                        } 
                                     
                                
                                    }
                                });
                    
                }
            }
        })
    });


// if (req.body.business == '' || req.body.business == null ) {
        //     req.body.permission === 'moderator';
        //     user.permission === req.body.permission;
        // } 